<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Building an Extensible, rEproducible, Test-driven, Harmonized, Open-source, Versioned, ENsemble model for air quality • beethoven</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Building an Extensible, rEproducible, Test-driven, Harmonized, Open-source, Versioned, ENsemble model for air quality">
<meta name="description" content="Near Real Time air pollution model results and code produced by the SET group. It is fully tested, versioned, and open source and open access.">
<meta property="og:description" content="Near Real Time air pollution model results and code produced by the SET group. It is fully tested, versioned, and open source and open access.">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">beethoven</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.5.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="articles/index.html">Articles</a></li>
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json">
</form></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/NIEHS/beethoven/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><div class="section level1">
<div class="page-header"><h1 id="building-an-extensible-reproducible-test-driven-harmonized-open-source-versioned-ensemble-model-for-air-quality-">Building an Extensible, rEproducible, Test-driven, Harmonized, Open-source, Versioned, ENsemble model for air quality <a href="https://niehs.github.io/beethoven"><img align="right" src="reference/figures/beethoven-logo.png" width="168px" alt="two hexagons with distributed tan, orange, and teal with geometric symbols placed. Two hexagons are diagonally placed from the top left to the bottom right"></a><a></a>
<a class="anchor" aria-label="anchor" href="#building-an-extensible-reproducible-test-driven-harmonized-open-source-versioned-ensemble-model-for-air-quality-"></a>
</h1></div>
<p>
</p>
<p><a href="https://github.com/NIEHS/beethoven/actions/workflows/check-standard.yaml" class="external-link"><img src="https://github.com/NIEHS/beethoven/actions/workflows/check-standard.yaml/badge.svg" alt="R-CMD-check"></a> <a href="https://github.com/NIEHS/beethoven/actions/workflows/test-coverage.yaml" class="external-link"><img src="https://NIEHS.github.io/beethoven/badges/coverage.svg" alt="cov"></a> <a href="https://github.com/NIEHS/beethoven/actions/workflows/lint.yaml" class="external-link"><img src="https://github.com/NIEHS/beethoven/actions/workflows/lint.yaml/badge.svg" alt="lint"></a> <a href="https://lifecycle.r-lib.org/articles/stages.html#experimental" class="external-link"><img src="https://img.shields.io/badge/lifecycle-experimental-orange.svg" alt="Lifecycle: experimental"></a></p>
<p>Group Project for the Spatiotemporal Exposures and Toxicology group with help from friends <span class="emoji" data-emoji="smiley">😃</span> <span class="emoji" data-emoji="cowboy_hat_face">🤠</span> <span class="emoji" data-emoji="earth_americas">🌎</span></p>

<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"NIEHS/beethoven"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="workflow">Workflow<a class="anchor" aria-label="anchor" href="#workflow"></a>
</h2>
<p><code>beethoven</code> is a <a href="https://books.ropensci.org/targets/" class="external-link">targets</a> reproducible analysis pipeline with the following workflow.</p>
<div class="float">
<img src="reference/figures/pipeline-outline.png" alt="beethoven workflow"><div class="figcaption">
<code>beethoven</code> workflow</div>
</div>
<p>Version 0.4.4 of <code>beethoven</code> has stable <code>targets</code> for downloading data files, calculating features at AQS sites, and merging to a base learner-ready <code>data.table</code> (<code>dt_feat_calc_xyt</code>). Ongoing changes relate to calculating features for the prediction grid, computationally managing prediction grid, base learner hyperparameter tuning, and meta learner function development.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">targets</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_visnetwork.html" class="external-link">tar_visnetwork</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="float">
<img src="reference/figures/visnetwork_20250128.png" alt="beethoven targets::tar_visnetwork()"><div class="figcaption">
<code>beethoven</code> targets::tar_visnetwork()</div>
</div>
</div>
<div class="section level2">
<h2 id="organization">Organization<a class="anchor" aria-label="anchor" href="#organization"></a>
</h2>
<p>Here, we describe the structure of the repository, important files, and the <code>targets</code> object naming conventions.</p>
<div class="section level3">
<h3 id="folder-structure">Folder Structure<a class="anchor" aria-label="anchor" href="#folder-structure"></a>
</h3>
<ul>
<li>
<code>R/</code> is where the <code>beethoven</code> functions are stored. Only “.R” files should be in this folder (ie. <code>targets</code> helpers, post-processing, model fitting functions).</li>
<li>
<code>inst/</code> is a directory for arbitrary files outside of the main <code>R/</code> directory
<ul>
<li>
<code>targets/</code> is a sub-directory within <code>inst/</code> which contains the pipeline files (ie. “targets_aqs.R”). These files declare the <code><a href="https://docs.ropensci.org/targets/reference/tar_target.html" class="external-link">targets::tar_target</a></code> objects which constitute the <code>beethoven</code> pipeline.</li>
</ul>
</li>
<li>
<code>tests/</code> stores unit and integration tests (<code>testthat/</code>) and test data (<code>testdata/</code>) according to the <a href="https://testthat.r-lib.org/" class="external-link">testthat</a> package’s standard structure. for unit testing.
<ul>
<li>
<code>testthat.R</code> is created and maintained by <code>testthat</code>, and is not to be edited manually.</li>
</ul>
</li>
<li>
<code>container/</code> stores definition files and build scripts to build covariate- and model-specific Apptainer container images (<code>container_covariates.def</code> and <code>container_models.def</code>).</li>
<li>
<code>man/</code> contains function documentation files (“.Rd”) which are by the <a href="https://roxygen2.r-lib.org/" class="external-link">roxygen2</a> package. These files are not to be edited manually.</li>
<li>
<code>vignettes/</code> contains “.Rmd” narrative text and code files. These are rendered by <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> into the <a href="https://niehs.github.io/beethoven/articles/index.html">Articles</a> section of the <code>beethoven</code> webpage.</li>
<li>
<code>.github/workflows/</code> is a hidden directory which stores the GitHub CI/CD “yaml” files.</li>
<li>
<code>tools/</code> is dedicated to educational or demonstration material (e.g. Rshiny), but is not excluded from the package build.</li>
</ul>
</div>
<div class="section level3">
<h3 id="important-files">Important Files<a class="anchor" aria-label="anchor" href="#important-files"></a>
</h3>
<ul>
<li>
<code>_targets.R</code> configures <code>targets</code> settings, creates computational resource controllers, and structures the <code>beethoven</code> pipeline.
<ul>
<li>To run <code>beethoven</code>, users must review and update the following parameters for their user profile and computing system:
<ul>
<li>
<code>controller_*</code> Ensure the local controllers do not request more CPUs than are available on your machine or high performance system.</li>
<li>
<code>#SBATCH --partition</code> Utilization of NVIDIA GPUs (within <code><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue::glue</a></code> command)</li>
<li>
<code>--bind /USER_PATH_TO_INPUT/input:/input</code> (within <code><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue::glue</a></code> command)</li>
</ul>
</li>
</ul>
</li>
<li>
<code>_targets.yaml</code> is created and updated by running <code><a href="https://docs.ropensci.org/targets/reference/tar_make.html" class="external-link">targets::tar_make</a></code> and is not to be edited manually.</li>
<li>
<code>run.sh</code> submits separate <code>SBATCH</code> jobs for the covariate, cpu- and gpu-enabled base learner, and the meta learner <code>targets</code> (see <code>/inst/scripts/</code>). This setup ensures that each stage utilizes the proper container image and computational resources. To run <code>beethoven</code>, users must review and update the following parameters for their user profile and computing system in each of the <code>inst/scripts/run_*</code> files.:
<ul>
<li><code>#SBATCH --mail-user</code></li>
<li><code>#SBATCH --partition</code></li>
<li><code>#SBATCH --mem</code></li>
<li><code>#SBATCH --cpus-per-task</code></li>
<li><code>--bind /USER_PATH_TO_INPUT/input:/input</code></li>
<li><code>--bind /USER_PATH_TO_SLURM/slurm:/USER_PATH_TO_SLURM/slurm</code></li>
</ul>
</li>
</ul>
</div>
<div class="section level3">
<h3 id="running-beethoven-pipeline">Running <code>beethoven</code> Pipeline<a class="anchor" aria-label="anchor" href="#running-beethoven-pipeline"></a>
</h3>
<div class="section level4">
<h4 id="user-settings">User settings<a class="anchor" aria-label="anchor" href="#user-settings"></a>
</h4>
<p><code>beethoven</code> pipeline is configured for SLURM with defaults for NIEHS HPC settings. For adapting the settings to users’ environment, consult with the documentation of your platform and edit the requested resources in the stage-specific run files (<code>/inst/scripts/</code>) (lines 3-11) and <code>_targets.R</code> (lines 41-45; individual <code>crew</code> and <code>crew.cluster</code> controller workers).</p>
</div>
<div class="section level4">
<h4 id="critical-targets">Critical <code>targets</code>
<a class="anchor" aria-label="anchor" href="#critical-targets"></a>
</h4>
<p>There are 5 “critical” <code>targets</code> that users may want to change to run <code>beethoven</code>.</p>
<ul>
<li>
<code>chr_daterange</code>
<ul>
<li>Controls all time-related targets for the entire pipeline. This is the only <code>target</code> that needs to be changed to update the pipeline with a new temopral range. Month and year specific arguments are derived from the time range defined by <code>chr_daterange</code>.</li>
</ul>
</li>
<li>
<code>chr_nasa_token</code>
<ul>
<li>Sets the file path to the user’s NASA Earthdata account credentials. These credentials expire at ~90 day intervals and therefore must be updated regularly.</li>
</ul>
</li>
<li>
<code>chr_mod06_links</code>
<ul>
<li>The file path to the MOD06 links file. These links must be manually downloaded per the <code><a href="https://niehs.github.io/amadeus/reference/download_modis.html" class="external-link">amadeus::download_modis</a></code> function. The links are then stored in a CSV file that is read by the function. The new file with links must be updated to match the new date range.</li>
</ul>
</li>
<li>
<code>chr_input_dir</code>
<ul>
<li>The file path to the input directory. This target controls where the raw data files are downloaded to and imported from. This file path must be mounted to the container at run time in the <code>run.sh</code> script.</li>
</ul>
</li>
<li>
<code>num_dates_split</code>
<ul>
<li>Controls the size of temporal splits. Splitting the temporal range into smaller chunks allows for parallel processing across multiple workers. It also allows for dispatching new dynamic branches when the temporal range is updated.</li>
</ul>
</li>
</ul>
</div>
<div class="section level4">
<h4 id="apptainer">
<code>Apptainer</code><a class="anchor" aria-label="anchor" href="#apptainer"></a>
</h4>
<p>Current implementation of <code>beethoven</code> utilizes <code>Apptainer</code> images to run the pipeline with consistent package versions and custom installations. Users must build these images before runnning beethoven.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="bu">cd</span> container/ <span class="co"># must be working in the `container/` directory</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="fu">sh</span> build_container_covariates.sh <span class="co"># build "covariates" stage image</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="fu">sh</span> build_container_models.sh <span class="co"># build "models" image</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="fu">mv</span> <span class="pp">*</span>sif ../ <span class="co"># move images to `beethoven/` root directory</span></span></code></pre></div>
<blockquote>
<p>[!NOTE] <code>.sif</code> files are omitted from GitHub due to size (&gt;5 Gb each)</p>
</blockquote>
</div>
<div class="section level4">
<h4 id="run">Run<a class="anchor" aria-label="anchor" href="#run"></a>
</h4>
<p>After switching back to the project root directory, users can run the pipeline with the <code>run.sh</code> shell script. The following lines of <code>/inst/scripts/run_*.sh</code> must be updated with user-specific settings before running the pipeline</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="co">#SBATCH --mail-user=[USER_EMAIL]      # email address for job notifications</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="co">#SBATCH --partition=[PARTITION_NAME]  # HPC partition to run on</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="co">#SBATCH --mem=[###G]                  # Total memory for the job</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a><span class="co">#SBATCH --cpus-per-task=[</span><span class="al">###</span><span class="co">]         # Total CPUs for the job</span></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>  <span class="ex">--bind</span> <span class="pp">[</span><span class="ss">USER_INPUT_DIRECTORY</span><span class="pp">]</span>/input:/input <span class="dt">\</span></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>...</span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>  <span class="ex">--bind</span> <span class="pp">[</span><span class="ss">USER_SYSTEM_PATH/munge</span><span class="pp">]</span>:/run/munge <span class="dt">\</span></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>  <span class="at">--bind</span> <span class="pp">[</span><span class="ss">USER_SYSTEM_PATH/slurm</span><span class="pp">]</span>:<span class="pp">[</span><span class="ss">USER_SYSTEM_PATH/slurm</span><span class="pp">]</span> <span class="dt">\</span></span></code></pre></div>
<p>Once configured, the pipeline can be run with a <code>SLRUM</code> batch job.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="bu">cd</span> ../ <span class="co"># assuming still in the `container/` directory</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="ex">sbatch</span> run.sh</span></code></pre></div>
<p>The SLURM batch job can also be submitted <code>R</code> session with the <code>batch</code> helper function.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="st">"R/helpers.R"</span><span class="op">)</span></span>
<span><span class="fu">batch</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
</div>
</div>
<div class="section level1">
<h1 id="contribution">Contribution<a class="anchor" aria-label="anchor" href="#contribution"></a>
</h1>
<p>The <a href="https://github.com/NIEHS/beethoven/tree/main/inst/targets#developers-guide" class="external-link">Developer’s Guide</a> provides detailed instructions for how to develop or update <code>beethoven</code> settings or individual <code>targets</code> objecdts</p>
<p>To contribute developments or modifications, open a <a href="https://github.com/NIEHS/beethoven/pulls" class="external-link">Pull request</a> into the <code>dev</code> branch with a detailed description of the proposed changes. Pull requests must pass all status checks, and then will be approved or rejected by <code>beethoven</code>’s authors.</p>
<p>Utilize <a href="https://github.com/NIEHS/beethoven/issues" class="external-link">Issues</a> to notify the authors of bugs, questions, or recommendations. Identify each issue with the appropriate label to help ensure a timely response.</p>
</div>

  </main><aside class="col-md-3"><div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/NIEHS/beethoven/" class="external-link">Browse source code</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php" class="external-link">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing beethoven</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Kyle Messier <br><small class="roles"> Author, maintainer </small> <a href="https://orcid.org/0000-0001-9508-9623" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a>  </li>
<li>Mitchell Manware <br><small class="roles"> Author, contributor </small> <a href="https://orcid.org/0009-0003-6440-6106" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a>  </li>
<li>Insang Song <br><small class="roles"> Author, contributor </small> <a href="https://orcid.org/0000-0001-8732-3256" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a>  </li>
<li>Eva Marques <br><small class="roles"> Author, contributor </small> <a href="https://orcid.org/0000-0001-9817-6546" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a>  </li>
<li>Anisha Singh <br><small class="roles"> Author, contributor </small> <a href="https://orcid.org/0000-0002-7540-0856" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a>  </li>
<li>Lara Clark <br><small class="roles"> Author, contributor </small> <a href="https://orcid.org/0000-0001-6940-5442" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a>  </li>
<li>Mariana Alifa Kassien <br><small class="roles"> Author, contributor </small> <a href="https://orcid.org/0000-0003-2295-406X" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a>  </li>
<li>Cavin Ward-Caviness <br><small class="roles"> Author, contributor </small> <a href="https://orcid.org/0000-0002-6322-4349" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a>  </li>
</ul>
</div>



  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Kyle Messier, Mitchell Manware, Insang Song, Eva Marques, Anisha Singh, Lara Clark, Mariana Alifa Kassien, Cavin Ward-Caviness.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
