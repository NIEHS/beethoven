BootStrap: docker
From: rocker/ml-verse:latest

%post
    # Update package list
    apt-get update

    # Install locales and generate the necessary locale
    apt-get install -y locales
    locale-gen en_US.UTF-8

    # Install fonts for Unicode support
    apt-get install -y fonts-dejavu fonts-liberation fonts-noto \
        fonts-unifont

    # Install NVIDIA toolkit (nvcc) for CUDA 11.8
    apt-get update && apt-get install -y --no-install-recommends \
        cuda-toolkit-11-8 && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

    # Create directories
    mkdir /pipeline
    mkdir /input
    mkdir /opt/_targets

    # Install R packages
    Rscript -e "install.packages(c('pak', 'targets', 'tarchetypes', \
        'testthat', 'tidymodels', 'bonsai', 'qs2', \
        'torch', 'tidyverse', 'xgboost', 'glmnet', 'lightgbm'))"
    Rscript -e "options(timeout = 1800); torch::install_torch(version = 'latest', type = 'gpu')"
    Rscript -e "pak::pak('tidymodels/brulee@gpu')"
    Rscript -e "pak::pak('shikokuchuo/nanonext'); pak::pak('shikokuchuo/mirai')"
    Rscript -e "pak::pak('wlandau/crew'); pak::pak('wlandau/crew.cluster')"
    Rscript -e "pak::pak('NIEHS/beethoven@dev-mm-0108')"

%environment
    # Set locale for the container environment
    export LANG=en_US.UTF-8
    export LC_ALL=en_US.UTF-8
    export TERM=xterm-256color

%runscript

%labels
    Basic machine learning with targets and crew plus unicode text; built \
    from Rocker ml-verse (nvidia/cuda:11.8.0-cudnn8-devel-ubuntu22.04).
